# Asset Cache Proxy

A Cloudflare Worker proxy that caches assets from the Google Gemini API and Replicate.com using an R2 storage bucket. This enables efficient, cost-effective, and persistent caching of large assets (such as video files) generated by AI services, reducing redundant API calls and improving response times for repeated requests.

## Features
- **Proxy and cache for Google Gemini API video assets**
- **Proxy and cache for Replicate.com video assets**
- **Persistent storage using Cloudflare R2**
- **Automatic cache lookup and population**
- **Fast delivery for repeated requests (cache hits)**

## How It Works
- When a request is made for a Gemini or Replicate asset, the Worker first checks the R2 bucket for a cached copy.
- If found, the asset is served directly from R2 (cache hit).
- If not found, the Worker fetches the asset from the upstream API, stores it in R2, and then serves it to the client (cache miss).

## Endpoints

### Gemini API
- `GET /api/gemini/veo/:videoid/:apikey`
- `GET /api/gemini/veo/:videoid/:apikey/video.mp4`

### Replicate.com
- `GET /api/replicate/:key1/:key2/:key3`

## Usage

1. **Install dependencies:**
   ```sh
   yarn install
   ```
2. **Start local development:**
   ```sh
   yarn dev
   ```
3. **Deploy to Cloudflare:**
   ```sh
   yarn deploy
   ```
4. **Generate/synchronize types:**
   ```sh
   yarn cf-typegen
   ```

## Configuration

- The R2 bucket binding is defined in `wrangler.toml` as `MEDIA_BUCKET`.
- You must have a Cloudflare account and an R2 bucket set up. Update the `bucket_name` in `wrangler.toml` as needed.
- API keys for Gemini and Replicate are passed as part of the request path.

## Example Request

```
GET /api/gemini/veo/VIDEO_ID/API_KEY
GET /api/replicate/xezq/IjJpp5sfup1wFinC840xiwvRHO06E2seo3ZG1J4J5aolPE0UA/tmpcpjkrycc.mp4
```

## Project Structure
- `src/routes/geminiApiRoute.ts` – Handles Gemini API proxying and caching
- `src/routes/replicateApiRoute.ts` – Handles Replicate.com proxying and caching
- `src/routes/R2Helper.ts` – Helper for R2 storage operations
- `src/index.ts` – Main entry point and route registration

## Notes
- Pass the `CloudflareBindings` as generics when instantiating `Hono`:
  ```ts
  // src/index.ts
  const app = new Hono<{ Bindings: CloudflareBindings }>()
```